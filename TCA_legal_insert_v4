Option Explicit

'========================
' USER CONFIG
'========================
Private Const DICT_PATH As String = "C:\Path\To\Your\TCA_Dictionary.tsv"

'========================
' WIN32: ESC KEY CHECK
'========================
#If VBA7 Then
    Private Declare PtrSafe Function GetAsyncKeyState Lib "user32" (ByVal vKey As Long) As Integer
#Else
    Private Declare Function GetAsyncKeyState Lib "user32" (ByVal vKey As Long) As Integer
#End If

Private Const VK_ESCAPE As Long = 27

Private Const ERR_ESC As Long = vbObjectError + 1000
Private Const ERR_USER_EXIT As Long = vbObjectError + 1001
Private Const ERR_NO_FILE As Long = vbObjectError + 2000

Private Function EscPressed() As Boolean
    EscPressed = (GetAsyncKeyState(VK_ESCAPE) And &H8000) <> 0
End Function

Private Sub ExitIfEsc()
    If EscPressed() Then Err.Raise ERR_ESC, , "ESC pressed."
End Sub

'========================
' ENTRY POINT
'========================
Public Sub Insert_TCA_With_Labels_From_TSV()
    On Error GoTo CleanFail

    Dim dict As Object
    Set dict = LoadTwoColTsvDictionary(DICT_PATH)

    Dim i As Long
    For i = 1 To 3
        ExitIfEsc

        Dim t As String, c As String, p As String
        Dim keyTitle As String, keyChap As String, keyPart As String

        ' TITLE (required)
        t = PromptOrExit("Enter Title number (ESC / Cancel / blank exits):", "TCA Insert – Title")
        keyTitle = MakeTcaKey(t, "", "")
        If Not dict.Exists(keyTitle) Then
            MsgBox "Not found in dictionary: " & keyTitle, vbExclamation, "Validation Failed"
            Exit Sub
        End If

        ExitIfEsc

        ' CHAPTER (required)
        c = PromptOrExit("Enter Chapter number for Title " & t & " (ESC / Cancel / blank exits):", "TCA Insert – Chapter")
        keyChap = MakeTcaKey(t, c, "")
        If Not dict.Exists(keyChap) Then
            MsgBox "Not found in dictionary: " & keyChap, vbExclamation, "Validation Failed"
            Exit Sub
        End If

        ExitIfEsc

        ' PART (optional) — if blank/cancel, we exit macro per your instruction
        p = PromptOrExit("Enter Part number for Title " & t & ", Chapter " & c & " (ESC / Cancel / blank exits):", "TCA Insert – Part")
        keyPart = MakeTcaKey(t, c, p)
        If Not dict.Exists(keyPart) Then
            MsgBox "Not found in dictionary: " & keyPart, vbExclamation, "Validation Failed"
            Exit Sub
        End If

        ExitIfEsc

        ' INSERT (labels + dictionary values; no styles)
        InsertLabelAndValue "Title " & t, CStr(dict(keyTitle))
        InsertLabelAndValue "Chapter " & c, CStr(dict(keyChap))
        InsertLabelAndValue "Part " & p, CStr(dict(keyPart))

        Selection.TypeParagraph ' spacer between portions
    Next i

    Exit Sub

CleanFail:
    ' Quiet exits
    If Err.Number = ERR_ESC Or Err.Number = ERR_USER_EXIT Then
        Exit Sub
    End If

    MsgBox "Macro stopped: " & Err.Description, vbExclamation, "Insert TCA"
End Sub

'========================
' TSV LOADER (2 columns: Key<TAB>Value)
'========================
Private Function LoadTwoColTsvDictionary(ByVal filePath As String) As Object
    ExitIfEsc

    Dim fso As Object, ts As Object
    Set fso = CreateObject("Scripting.FileSystemObject")

    If Not fso.FileExists(filePath) Then
        Err.Raise ERR_NO_FILE, , "TSV not found: " & filePath
    End If

    Set ts = fso.OpenTextFile(filePath, 1, False) 'ForReading=1

    Dim dict As Object
    Set dict = CreateObject("Scripting.Dictionary")
    dict.CompareMode = 1 ' vbTextCompare

    Do While Not ts.AtEndOfStream
        ExitIfEsc

        Dim line As String
        line = ts.ReadLine
        If Len(Trim$(line)) = 0 Then GoTo ContinueLoop

        Dim cols() As String
        cols = Split(line, vbTab)
        If UBound(cols) < 1 Then GoTo ContinueLoop

        Dim k As String, v As String
        k = Trim$(cols(0))
        v = cols(1)

        If k <> "" Then dict(k) = v

ContinueLoop:
    Loop

    ts.Close
    Set LoadTwoColTsvDictionary = dict
End Function

'========================
' KEY BUILDER
'========================
Private Function MakeTcaKey(ByVal t As String, ByVal c As String, ByVal p As String) As String
    t = Trim$(t): c = Trim$(c): p = Trim$(p)
    MakeTcaKey = "TCA|T=" & t & "|C=" & c & "|P=" & p
End Function

'========================
' PROMPT (EXIT-SAFE)
'========================
Private Function PromptOrExit(ByVal promptText As String, ByVal titleText As String) As String
    ExitIfEsc

    Dim v As String
    v = InputBox(promptText, titleText)

    ExitIfEsc

    v = Trim$(v)

    ' InputBox returns "" for Cancel and also for blank input
    If v = "" Then Err.Raise ERR_USER_EXIT, , "User cancelled or entered blank."

    PromptOrExit = v
End Function

'========================
' INSERT (NO STYLING)
'========================
Private Sub InsertLabelAndValue(ByVal labelText As String, ByVal valueText As String)
    ExitIfEsc
    Selection.TypeText labelText
    Selection.TypeParagraph
    Selection.TypeText valueText
    Selection.TypeParagraph
    Selection.TypeParagraph
End Sub